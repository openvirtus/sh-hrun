#!/bin/sh -e
#L:
#L:  This software is free to use and modify, but not free to maintain.
#L:
#l:  Donate bitcoin: 1C1ZzDje7vHhF23mxqfcACE8QD4nqxywiV
#l:  Copyright (c) 2018 Openvirtus.com, http://openvirtus.com
#L:
#L:  Permission is hereby granted, free of charge, to any person obtaining
#L:  a copy of this software and associated documentation files (the
#L:  "Software"), to deal in the Software without restriction, including
#L:  without limitation the rights to use, copy, modify, merge, publish,
#L:  distribute, sublicense, and/or sell copies of the Software, and to
#L:  permit persons to whom the Software is furnished to do so, subject to
#L:  the following conditions:
#L:
#L:  The above copyright notice and this permission notice shall be
#L:  included in all copies or substantial portions of the Software.
#L:
#L:  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
#L:  EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
#L:  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
#L:  NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
#L:  LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
#L:  OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
#L:  WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
#L:
#r: ## HCCRUN
#r:
#h: Usage: $0 [OPTS...] [C-FILE] [ARGS...]
#h:
#h: This program helps executing C files as scripts. In order to this to work
#h: start your scripts with `//bin/true && exec hccrun "$0" "$@"`
#h: and name it with the proper suffix (.c/.cc).
#h:
#h: You can put options for the compiler with `//hccrun/ldflags: -lpthread`.
#h:
#h: -v                : Show configuration.
#h: -i PROG PARAMS... : Do not execute, instead extract parameters.
#r:
. hrun
hccrun() {
    ## Parse options.
    local OPTIND optopt= ops= toolchain= param=
    while getopts "vt:gi" optopt;do # OPTARG
        local ops="${ops}${optopt}"
        case $optopt in
            g)  export HRUN_ENABLE_GDB=y    ;;
            t)  local toolchain="${OPTARG}" ;;
            \?) return 1;;
        esac
    done
    shift $(( $OPTIND - 1 ))
    ## Calculate variables.
    hccrun_calc_variables "${toolchain}"
    ## Execute options.
    case "${ops}" in *v*) hccrun_show_variables;; esac
    ## Process the file.
    if test -n "$1";then
        local filename="`which "$1"`"
        if test ! -n "${filename}";then
            echo "hccrun: error: Can't find '${1}' in your path." >&2
            exit 1
        fi
        shift
        case "${ops}" in
            *i*) hccrun_get_params "${filename}" "$@"  ;;
            *)   hccrun_execute    "${filename}" "$@"     ;;
        esac
    fi
}
hccrun_show_variables() {
    hrun_show_variables
    printf '## COMPILER\n\n'
    printf '%-20s: %s\n' HCCRUN_CACHE         "${HCCRUN_CACHE}"
    printf '%-20s: %s\n' HCCRUN_CC            "${HCCRUN_CC}"
    printf '%-20s: %s\n' HCCRUN_INCLUDE_CACHE "${HCCRUN_INCLUDE_CACHE}"
    printf '%-20s: %s\n' HCCRUN_INCLUDE_PATH  "${HCCRUN_INCLUDE_PATH}"
    printf '\n'
}
hccrun_calc_variables() {
    hrun_calc_variables "$1"
    HCCRUN_CACHE="${HCCRUN_CACHE:-${HOME}/.hccrun}"
    HCCRUN_CC="${HCCRUN_CC:-gcc}"
    HCCRUN_INCLUDE_CACHE="${HCCRUN_INCLUDE_CACHE:-${HOME}/.emacs.d/include}"
    HCCRUN_INCLUDE_PATH="${HCCRUN_INCLUDE_PATH:-}"
}
## --------------------------------------------------------------------------
hccrun_get_params() {
    local filename="$1" param=
    shift
    for param in "$@";do
        sed -n 's|^//hccrun/'"${param}"' *: *||p' ${filename}
    done
}
hccrun_execute() {
    local filename="$1" incdir= incname=
    shift
    local cache_file="${HCCRUN_CACHE}/`basename ${filename}`"
    mkdir -p "${HCCRUN_CACHE}" "${HCCRUN_INCLUDE_CACHE}"
    for incdir in ${HCCRUN_INCLUDE_PATH};do
        incname="`basename ${incdir}`"
        rm -f "${HCCRUN_INCLUDE_CACHE}"/"${incname}"
        ln -s "${incdir}" "${HCCRUN_INCLUDE_CACHE}"/"${incname}"
    done
    export LD_LIBRARY_PATH="${HPKG_SYSROOT}/lib64:${HPKG_SYSROOT}/lib${LD_LIBRARY_PATH:+:}${LD_LIBRARY_PATH}"
    "${HCCRUN_CC}" -o "${cache_file}"                                       \
                   `hccrun_get_params ${filename} cflags cppflags cxxflags` \
                   -I"${HPKG_SYSROOT}/include"                              \
                   -I"${HCCRUN_INCLUDE_CACHE}"                              \
                   "${filename}"                                            \
                   `hccrun_get_params ${filename} ldflags`                  \
                   -L"${HPKG_SYSROOT}/lib"                                  \
                   `hccrun_get_params ${filename} libs`
    
    export PATH="${HPKG_SYSROOT}/bin:${HPKG_SYSROOT}/sbin${PATH:+:}${PATH}"
    if test @"${HRUN_ENABLE_GDB}" = @"y";then
        export LANG="en_EN.utf8"
        exec "${HRUN_GDB}"                                                   \
            -q -ex "start" -ex "continue" -ex "backtrace" --ex "quit" --args \
            "${cache_file}" "$@"
        # Emacs: -i=mi -ex "start" -ex "record btrace pt" --args "${executable}" "$@"
    else
        exec "${cache_file}" "$@"
    fi
}


## --------------------------------------------------------------------------
if test @"`basename "$0"`" = @"hccrun";then
    if test -n "$1";then
        hccrun "$@"
    else
        sed -n 's/^ *#h: \{0,1\}//p' "$0" | sed "s|\\\$0|`basename $0`|g"
        echo ""
        sed -n 's/^ *#l: \{0,1\}//p' "$0"
    fi
fi
