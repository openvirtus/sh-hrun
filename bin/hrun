#!/bin/sh -e
#L:
#l:  Copyright (c) 2018 Openvirtus.com, http://openvirtus.com
#L:
#L:  Permission is hereby granted, free of charge, to any person obtaining
#L:  a copy of this software and associated documentation files (the
#L:  "Software"), to deal in the Software without restriction, including
#L:  without limitation the rights to use, copy, modify, merge, publish,
#L:  distribute, sublicense, and/or sell copies of the Software, and to
#L:  permit persons to whom the Software is furnished to do so, subject to
#L:  the following conditions:
#L:
#L:  The above copyright notice and this permission notice shall be
#L:  included in all copies or substantial portions of the Software.
#L:
#L:  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
#L:  EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
#L:  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
#L:  NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
#L:  LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
#L:  OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
#L:  WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
#L:
#h: Usage: $0 [-v] [-l] [-t TOOLCHAIN] [-gms] [-b FUNC] PROGRAM [ARGS...]
#h:
#h: This program helps executing programs installed in another prefixes.
hrun() {
    ## Parse command line arguments.
    local OPTIND optopt= ops= toolchain=
    while getopts "vlt:gmsb:" optopt;do # OPTARG
        local ops="${ops}${optopt}"
        case $optopt in
            g)  export HRUN_ENABLE_GDB=y        ;;
            m)  export HRUN_ENABLE_VALGRIND=y   ;;
            s)  export HRUN_ENABLE_STRACE=y     ;;
            b)  export HRUN_GDB_COMMANDS="break ${OPTARG}";;
            t)  local toolchain="${OPTARG}"     ;;
            \?) return 1;;
        esac
    done
    shift $(( $OPTIND - 1 ))
    ## Calculate variables.
    hrun_calc_variables "${toolchain}"
    ## Show operations.
    case "${ops}" in *v*) hrun_show_variables;; esac
    ## Execute.
    if test -n "$1";then
        export LD_LIBRARY_PATH="${HPKG_SYSROOT}/lib64:${HPKG_SYSROOT}/lib${LD_LIBRARY_PATH:+:}${LD_LIBRARY_PATH}"
        export PATH="${HPKG_SYSROOT}/bin:${HPKG_SYSROOT}/sbin${PATH:+:}${PATH}"
        hrun_exec "$@"
    fi
}
## ---------------------------------------------------------------------------
hrun_show_variables() {
    printf '\n## OPTIONS\n\n' 
    printf '%-20s: %s\n' HPKG_DIRECTORY       "${HPKG_DIRECTORY}"
    printf '%-20s: %s\n' HRUN_ENABLE_GDB      "${HRUN_ENABLE_GDB}"
    printf '%-20s: %s\n' HRUN_ENABLE_VALGRIND "${HRUN_ENABLE_VALGRIND}"
    printf '%-20s: %s\n' HRUN_GDB             "${HRUN_GDB}"
    printf '\n## CALCULATED\n\n'
    printf '%-20s: %s\n' HPKG_TARGET_BUILD "${HPKG_TARGET_BUILD}"
    printf '\n## READ FROM TOOLCHAIN\n\n'
    printf '%-20s: %s\n' HPKG_SYSROOT      "${HPKG_SYSROOT}"
    printf '%-20s: %s\n' HPKG_CONFIG       "${HPKG_CONFIG}"
    printf '\n'
}
hrun_calc_variables() {

    ## Get options.
    HPKG_DIRECTORY="${HPKG_DIRECTORY:-${HOME}/.hpkg}"
    HRUN_ENABLE_GDB="${HRUN_ENABLE_GDB:-n}"
    HRUN_GDB="/usr/bin/gdb"

    ## Calculate variables.
    HPKG_TARGET_BUILD="${1:-`uname -m`-linux-gnu}"

    ## Source target.
    HPKG_SYSROOT=/usr/local
    if test -f "${HPKG_DIRECTORY}/${HPKG_TARGET_BUILD}.sh";then
        HPKG_CONFIG="${HPKG_DIRECTORY}/${HPKG_TARGET_BUILD}.sh"
        . "${HPKG_CONFIG}"
    else
        HPKG_CONFIG=
    fi
}
## ---------------------------------------------------------------------------
hrun_exec() {
    local executable="`which "${1}"`"
    shift
    if test @"${HRUN_ENABLE_STRACE}" = @"y";then
        strace "${executable}" "$@"
    elif test @"${HRUN_ENABLE_GDB}" = @"y";then
        LANG="en_EN.utf8" "${HRUN_GDB}"                                      \
            -q  \
            -ex "start" -ex "${HRUN_GDB_COMMANDS}" -ex "continue" -ex "backtrace" \
             --args \
            "${executable}" "$@"
        # Emacs: -i=mi -ex "start" -ex "record btrace pt" --args "${executable}" "$@"
    elif test @"${HRUN_ENABLE_VALGRIND}" = @"y";then
        LANG="en_EN.utf8" valgrind    \
            --leak-check=full         \
            --log-file="valgrind.log" \
            "${executable}" "$@"
    else
        "${executable}" "$@"
    fi
}





## ---------------------------------------------------------------------------
if test @"`basename "$0"`" = @"hrun";then
    if test -n "$1";then
        hrun "$@"
    else
        sed -n 's/^ *#h: \{0,1\}//p' "$0" | sed "s|\\\$0|`basename $0`|g"
        echo ""
        sed -n 's/^ *#l: \{0,1\}//p' "$0"
    fi
fi
